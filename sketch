#!/usr/bin/env python

import curses
from contextlib import AbstractContextManager


class Renderer(AbstractContextManager):
    table = [
        " ", "ğŸ®¢", "ğŸ®£", "â”€",
        "ğŸ®¡", "ğŸ®¨", "â”‚", "ğŸ® ",
        "ğŸ® ", "â”‚", "ğŸ®©", "ğŸ®¡",
        "â”€", "ğŸ®£", "ğŸ®¢", " "
    ]

    def __enter__(self):
        # set up terminal
        self.stdscr = curses.initscr()
        curses.noecho()
        curses.cbreak()
        self.stdscr.keypad(True)
        try:
            curses.start_color()
        except:
            pass

        # initialize canvas and position
        max_y, max_x = self.stdscr.getmaxyx()
        self.canvas = [[False] * max_y for _ in range(max_x)]
        self.x, self.y = 0, 0

        return self

    def __exit__(self, *_):
        # reset terminal
        curses.echo()
        curses.nocbreak()
        self.stdscr.keypad(False)
        curses.endwin()

    def read_input(self):
        key = self.stdscr.getkey()

        match key:
            case "w":
                self.y = max(self.y - 1, 0)
            case "a":
                self.x = max(self.x - 1, 0)
            case "s":
                self.y = min(self.y + 1, len(self.canvas[0]) - 1)
            case "d":
                self.x = min(self.x + 1, len(self.canvas) - 1)

        self.canvas[self.x][self.y] = True

    def render(self):
        """render canvas using marching squares"""
        for i in range(len(self.canvas) - 1):
            for j in range(len(self.canvas[0]) - 1):
                x = 0
                if self.canvas[i][j + 1]:
                    x += 1
                if self.canvas[i + 1][j + 1]:
                    x += 2
                if self.canvas[i + 1][j]:
                    x += 4
                if self.canvas[i][j]:
                    x += 8

                try:
                    self.stdscr.addstr(j, i, Renderer.table[x])
                except:
                    pass


with Renderer() as renderer:
    # raise RuntimeError(
    #     f"max width: {len(renderer.canvas)}, max height: {len(renderer.canvas[0])}, max yx: {renderer.stdscr.getmaxyx()}")

    while True:
        renderer.render()
        renderer.read_input()
